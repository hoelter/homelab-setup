services:
  gluetun:
    image: qmcgaw/gluetun:v3.40.0
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    env_file: .env
    volumes:
      - /home/torrentuser/config/gluetun:/tmp/gluetun
    environment:
      - VPN_SERVICE_PROVIDER=protonvpn
      - VPN_TYPE=wireguard
      - VPN_PORT_FORWARDING_PROVIDER=protonvpn
      - VPN_PORT_FORWARDING=on
      - FIREWALL_VPN_INPUT_PORTS=8080
      - FIREWALL_INPUT_PORTS=8080
      - FIREWALL_OUTBOUND_SUBNETS=${DOCKER_SUBNET},${LOCAL_SUBNET}
      - VPN_PORT_FORWARDING_STATUS_FILE=/tmp/gluetun/forwarded_port
      - HEALTH_VPN_DURATION_INITIAL=30s
      - HEALTH_VPN_DURATION_ADDITION=5s
      - UPDATER_PERIOD=24h
      - LOG_LEVEL=debug
      - FIREWALL_DEBUG=on
      - VPN_PORT_FORWARDING_DEBUG=on
      - TZ=America/Chicago
    ports:
      - 8080:8080      # QB Web UI
      # - 6881:6881      # QB
      # - 6881:6881/udp  # QB
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ping -c 1 1.1.1.1 > /dev/null 2>&1 && test -f /tmp/gluetun/forwarded_port"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Chicago
      - WEBUI_PORT=8080
      # Enhanced logging for debugging
      - QBITTORRENT_ADDITIONAL_ARGS=--verbose
    volumes:
      - /home/torrentuser/config/qbittorrent:/config
      - /srv/torrents:/downloads
    network_mode: "service:gluetun"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  port-manager:
    image: alpine:3.20
    container_name: port-manager
    environment:
      - PORT_FORWARDED_FILE=/tmp/gluetun/forwarded_port
      - RECHECK_TIME=60
    network_mode: "service:gluetun"
    restart: unless-stopped
    volumes:
      - /home/torrentuser/config/gluetun:/tmp/gluetun
    depends_on:
      gluetun:
        condition: service_healthy
      qbittorrent:
        condition: service_healthy
    command: |
      sh -c '
      apk add --no-cache curl
      echo "Starting qBittorrent port manager"
      while ! curl -s -c /tmp/cookies -d "username=admin&password=adminadmin" http://localhost:8080/api/v2/auth/login | grep -q "Ok."; do
          echo "Authentication failed, retrying in 30s..."
          sleep 30
      done
      echo "Authenticated with qBittorrent"
      
      while true; do
          if [ -f "$$PORT_FORWARDED_FILE" ]; then
              new_port=$$(cat "$$PORT_FORWARDED_FILE" | tr -d "\n\r" | grep -o "[0-9]*")
              if [ -n "$$new_port" ] && [ "$$new_port" -gt 0 ]; then
                  current_port=$$(curl -s -b /tmp/cookies http://localhost:8080/api/v2/app/preferences | grep -o "\"listen_port\":[0-9]*" | cut -d: -f2)
                  if [ "$$current_port" != "$$new_port" ]; then
                      echo "Updating port: $$current_port -> $$new_port"
                      curl -s -b /tmp/cookies -d "json={\"listen_port\":$$new_port}" http://localhost:8080/api/v2/app/setPreferences
                  fi
              fi
          fi
          sleep "$$RECHECK_TIME"
          curl -s -b /tmp/cookies http://localhost:8080/api/v2/auth/login >/dev/null 2>&1 || {
              curl -s -c /tmp/cookies -d "username=admin&password=adminadmin" http://localhost:8080/api/v2/auth/login >/dev/null 2>&1
          }
      done
      '
    healthcheck:
      test: ["CMD", "sh", "-c", "pgrep -f 'Starting qBittorrent port manager' > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

